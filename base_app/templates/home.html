{% extends "base.html" %}

{% block title %}Enron | Accueil{% endblock %}

{% block navbar %}
    {# Définir quelle page est active #}
    <li class="text-red-700">
        <a href="{% url 'accueil' %}">Accueil</a>
    </li>
    <li class="hover:text-red-700">
        <a href="{% url 'personnes' %}">Personnes</a>
    </li>
    <li class="hover:text-red-700">
        <a href="{% url 'mails' %}">Mails</a>
    </li>
    <li class="hover:text-red-700">
        <a href="{% url 'favoris' %}">Favoris</a>
    </li>
{% endblock %}

{% block content %}
<div class="container mx-auto px-3 py-6 grid gap-6 max-w-[1280px]">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 gap-3 lg:gap-5 w-full">
        <!-- COLONNE GAUCHE -->
        <div>
            <!-- Première ligne (stats principales) -->
            <div class="grid grid-cols-1 sm:grid-cols-1 lg:grid-cols-3 gap-3 w-full text-center mb-3">
                <div class="flex flex-col items-center justify-between bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2">
                    <h3 class="mb-3 text-sm sm:text-base lg:text-lg">Nombre total de mails envoyés</h3>
                    <span class="text-red-700 font-bold text-lg sm:text-xl lg:text-2xl">{{email_count}}</span>
                </div>
                <div class="flex flex-col items-center justify-between bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2">
                    <h3 class="mb-3 text-sm sm:text-base lg:text-lg">Nombre total de personnes</h3>
                    <span class="text-red-700 font-bold text-lg sm:text-xl lg:text-2xl">{{people_count}}</span>
                </div>
                <div class="flex flex-col items-center justify-between bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2">
                    <h3 class="mb-3 text-sm sm:text-base lg:text-lg">Période couverte</h3>
                    <span class="text-red-700 font-bold text-lg sm:text-xl lg:text-2xl">{{covered_period}}</span>
                </div>
            </div>
            <!-- Deuxième ligne (Graphique) -->
<div class="bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2 mb-3">
    <div class="relative">
        <div class="absolute right-0 text-sm sm:text-sm lg:text-base">
            <!-- Sélecteur d'année -->
            <form method="get" action="{% url 'accueil' %}">
                <select class="bg-red-100 px-2 py-1 font-bold text-red-700 rounded-xl hover:cursor-pointer" name="year" onchange="this.form.submit()">
                    {% for year in years_list %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    <div class="flex flex-col items-center">
        <h3 class="mb-2 text-base font-bold text-red-700 text-center sm:text-base lg:text-xl">{{ selected_year }}</h3>
        <h3 class="mb-5 text-sm text-center sm:text-base lg:text-lg">Nombre de mails envoyés par mois</h3>
        <!-- Conteneur du graphique -->
        <div class="h-[300px] w-full">
            <canvas id="mailChart"></canvas>
        </div>
    </div>
</div>
            <!-- Troisième ligne (le plus d'échanges avec externes) -->
            <div class="flex flex-col items-center bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2 lg:mb-3">
                    <h3 class="mb-5 text-sm text-center sm:text-base lg:text-lg">Le plus d'échanges avec des externes</h3>
                    <div class="grid grid-cols-3 sm:grid-cols-3 lg:grid-cols-3 gap-x-5 gap-y-1 text-xs text-center sm:text-sm lg:text-base">
                        <span class="mb-1 text-neutral-500">Personne</span>
                        <span class="mb-2 text-neutral-500">Pourcentage</span>
                        <span class="mb-2 text-neutral-500"></span>
                        <span class="mb-1">Sandrine Baguette</span>
                        <span class="mb-2 text-red-700">(62%) - 280</span>
                        <div class="mb-3">
                            <a href="#" class="bg-red-100 text-red-700 font-bold px-3 py-1.5 rounded-xl hover:border">Ouvrir</a>
                        </div>
                        <span class="mb-1">Baptiste Sardine</span>
                        <span class="mb-2 text-red-700">(63%) - 250</span>
                        <div class="mb-3">
                            <a href="#" class="bg-red-100 text-red-700 font-bold px-3 py-1.5 rounded-xl hover:border">Ouvrir</a>
                        </div>
                        <span class="mb-1">Olivier Pichet</span>
                        <span class="mb-2 text-red-700">(57%) - 199</span>
                        <div class="mb-3">
                            <a href="#" class="bg-red-100 text-red-700 font-bold px-3 py-1.5 rounded-xl hover:border">Ouvrir</a>
                        </div>
                    </div>
                </div>
        </div>

        <!-- COLONNE DROITE -->
        <div>
            <div class="flex flex-col">
                <!-- Première ligne (top 3 personnes) -->
                <div class="flex flex-col items-center bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2 mb-3">
                    <h3 class="mb-5 text-sm text-center sm:text-base lg:text-lg">Top 3 des personnes les plus actives</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 gap-x-5 gap-y-2 text-xs text-center sm:text-sm lg:text-base">
                    {% for person in top3_people %}
                        <span class="mb-1">{{person.firstname}} {{person.lastname}}</span>
                        <div class="mb-2">
                            <a href="#" 
                            class="bg-red-100 text-red-700 font-bold px-3 py-1.5 rounded-xl hover:border" 
                            data-name="{{ person.firstname }} {{ person.lastname }}"
                            data-category="{{ person.category }}"
                            data-email="{{ person.email }}"
                            data-firstname="{{ person.firstname }}"
                            data-lastname="{{ person.lastname }}"
                            data-id="{{ person.id }}"
                            onclick="showInfo(event)">Ouvrir</a>
                        </div>
                    {% endfor %}
                    </div>
                </div>
                <!-- Deuxième ligne (top 3 mots) -->
                <div class="flex flex-col items-center bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2 mb-3">
                    <h3 class="mb-5 text-sm text-center sm:text-base lg:text-lg">Top 3 des mots les plus récurrents</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 gap-x-14 gap-y-1 text-xs text-center sm:text-sm lg:text-base">
                        {% for word in top3_words %}
                            <span class="mb-1">{{word.word}}</span>
                            <span class="mb-2 text-red-700">{{word.count}} fois</span>
                        {% endfor %}
                    </div>
                </div>
                <!-- Troisième ligne (semaines avec le plus d'échanges) -->
                <div class="flex flex-col items-center bg-white p-2 sm:p-4 rounded-xl border-gray-200 border-2 mb-3">
                    <h3 class="mb-5 text-sm text-center sm:text-base lg:text-lg">Semaine avec le plus d'échanges</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-2 gap-x-5 gap-y-1 text-xs text-center sm:text-sm lg:text-base">
                        <span class="mb-1 text-neutral-500">Semaine</span>
                        <span class="mb-2 text-neutral-500">Mails</span>
                        <span class="mb-1">12/09/2010 - 19/09/2010</span>
                        <span class="mb-2 text-red-700">756</span>
                        <span class="mb-1">09/02/2013 - 16/02/2013</span>
                        <span class="mb-2 text-red-700">602</span>
                        <span class="mb-1">13/11/2015 - 20/11/2015</span>
                        <span class="mb-2 text-red-700">601</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
  

<!-- Script pour le graphique -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Données pour le graphique (injectées depuis Django)
    const mailData = {{ mail_data|safe}};

    // Configuration du graphique avec Chart.js
    const ctx = document.getElementById('mailChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar', // Type de graphique (barres verticales)
        data: {
            labels: mailData.labels, // Mois (labels)
            datasets: [{
                label: 'Nombre de mails envoyés',
                data: mailData.values, // Nombre de mails par mois
                backgroundColor: 'rgba(75, 192, 192, 0.2)', // Couleur des barres
                borderColor: 'rgba(75, 192, 192, 1)', // Couleur des bordures
                borderWidth: 1 // Épaisseur des bordures
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true, // Commencer l'axe Y à 0
                    ticks: {
                        stepSize: 1, // Toujours incrémenter par 1 (pas de 0.5)
                        callback: function(value) {
                            return Number.isInteger(value) ? value : ''; // Afficher uniquement les entiers
                        }
                    },
                    title: {
                        display: true,
                        text: 'Nombre de mails', // Titre de l'axe Y
                        font: {
                            size: 14,
                            weight: 'bold' // Texte en gras pour l'axe Y
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mois', // Titre de l'axe X
                        font: {
                            size: 14,
                            weight: 'bold' // Texte en gras pour l'axe Y
                        }
                    }
                }
            }
        }
    });
</script>

<script>
    function showInfo(event) {
        event.preventDefault(); 

        const name = event.target.getAttribute('data-name');
        const category = event.target.getAttribute('data-category');
        const email = event.target.getAttribute('data-email');
        const firstname = event.target.getAttribute('data-firstname');
        const lastname = event.target.getAttribute('data-lastname');

        const tooltipContent = `
            <div>
                <strong>Nom :</strong> ${firstname} ${lastname}<br>
                <strong>Catégorie :</strong> ${category}<br>
                <strong>Email :</strong> ${email}
            </div>
        `;

        const tooltip = document.createElement('div');
        tooltip.classList.add('tooltip');
        tooltip.innerHTML = tooltipContent;
        
        tooltip.style.position = 'absolute';
        tooltip.style.backgroundColor = '#fff';
        tooltip.style.border = '1px solid #ccc';
        tooltip.style.borderRadius = '5px';
        tooltip.style.padding = '10px';
        tooltip.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
        tooltip.style.zIndex = '1000';

        const rect = event.target.getBoundingClientRect();
        tooltip.style.left = `${rect.left}px`;
        tooltip.style.top = `${rect.bottom + window.scrollY}px`;

        document.body.appendChild(tooltip);

        setTimeout(() => {
            tooltip.remove();
        }, 5000);  // L'infobulle disparaît après 5 secondes
    }
</script>

{% endblock %}